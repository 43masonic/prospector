<!doctype html>
<html>
  <head>
    <title>DORA</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
    <!--[if lte IE 8]>
        <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.ie.css" />
    <![endif]-->
    
    <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
    <style>
      html,body { height:100%; margin:0; 
        background-color: #222; color:lightgrey;
        font-family: Noto,Arial;
      }

      .box {display:flex; flex-flow:column; height:100%; width:100%;}
      .box .row {position:relative; z-index:0;}
      .box .row.content {flex: 1 1 auto; background-color:#333;} 
      
      #panel {background-color:#567; opacity:1;float:right; width:300px; height:100%;
	      z-index:10;
	      position:fixed;
	      padding:0px 10px 10px 10px;
	      right:0;
      }
    </style>    
  </head>
  
  <body>
    <div id="panel">
        <h3><b><i>FAST-TRIPS</i> &raquo; DATA EXPLORER</b></h3>
        <hr/><br/>
        
        <b>Person ID:</b>
        <form name="my" onsubmit="runFilter(cql_filter.value);return false">
          <input name="cql_filter" value="" size=36>
          <input type="submit">
        </form>
        <p style="font-size:smaller;"><i>Try: <u>mode='heavy_rail'</u> or <u>person_id='1775999_2'</u></i></p>
    </div>
    <div class="box">
      <div id="sfmap" class="row content"></div>
    </div>

    <script>
     'use strict';
      var mymap = L.map('sfmap').setView([37.75, -122.3], 11);
      var url = 'https://api.mapbox.com/styles/v1/mapbox/dark-v9/tiles/256/{z}/{x}/{y}?access_token={accessToken}';
      var token = 'pk.eyJ1IjoicHNyYyIsImEiOiJjaXFmc2UxanMwM3F6ZnJtMWp3MjBvZHNrIn0._Dmske9er0ounTbBmdRrRQ';
      var attribution ='<a href="http://openstreetmap.org">OpenStreetMap</a> | '+                       
                       '<a href="http://mapbox.com">Mapbox</a>';
      L.tileLayer(url, {
          attribution:attribution,
          maxZoom: 18,
          accessToken:token,
      }).addTo(mymap);

      var segmentLayer;
      
      var options = {
            typeName: 'mappoints:segments0',
            cql_filter: "(person_id='1736942_1' and pathnum=4)",
            service:'WFS',
            version:'1.1.0',
            request:'GetFeature',
            outputFormat: 'json',
      }

      function runFilter(form_filter) {
        if (segmentLayer) segmentLayer.remove()
        
        if (form_filter) options['cql_filter'] = `person_id='${form_filter}'`
        else return;

        queryServer();
      }      

      function addSegmentLayer(segments) {
        segmentLayer = L.geoJSON(segments, {
              style: function(feature) {
                switch (feature.properties.mode) {
                  case 'heavy_rail': return {color: "#ffff00"};
                  case 'commuter_rail': return {color: "#ff6666"};
                  case 'light_rail': return {color: "red"};
                  case 'local_bus': return {color: "#00ccff", "z-index":"20"};
                  case 'premium_bus': return {color: "#44ffaa"};
                  case 'express_bus': return {color: "#44ffaa"};
                  case 'ferry': return {color: "#ff8800"};
                  case 'transfer': return {color: "#446600", "z-index":"-1"};
                  default: return {color: "#446600", "z-index":"-1"};
                }
              }
        });
        segmentLayer.addTo(mymap);
      }
 
      function queryServer() {
        const geoserverUrl = 'http://dwdev:8080/geoserver/ows?';

        var esc = encodeURIComponent;
        var queryparams = Object.keys(options)
            .map(k => esc(k) + '=' + esc(options[k]))
            .join('&');

        // Fetch the segments
        fetch(geoserverUrl + queryparams, options)
          .then((resp) => resp.json())
          .then(function(jsonData) {
              addSegmentLayer(jsonData);
              
        }).catch(function(error) {
            console.log("err: "+error);
        });      
      }
      
      </script>        
  </body>
</html>
